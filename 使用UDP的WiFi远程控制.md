- # 概述
  
  远程控制是控制项目时使用的一种非常方便的技术。无论是机器人汽车、房屋能源管理系统，还是气象站；他们都可以从这种通信/控制方法中受益。
  
  可以使用手头微控制器的任何可用通信功能来实现远程控制。Bluetooth、Serial Comms、GSM、RF、WIFI 是我想到的方法。在本教程中，我们将特别关注基于 WIFI 的远程控制的使用，特别是使用[用户数据报协议的](https://en.wikipedia.org/wiki/User_Datagram_Protocol)远程控制。
  
  毫不奇怪，我们可以在 MicroBlocks WIFI 和 UDP 库的帮助下学习如何使用这项技术。虽然其他编程环境可能提供相同的功能，但 MicroBlocks 的实现特别简单明了。
- > “在计算机网络中，用户数据报协议 (UDP) 是 Internet 协议套件的核心通信协议之一，用于向 Internet 协议 (IP) 网络上的其他主机发送消息（以数据包的形式传输）。在 IP 中网络，UDP 不需要事先通信来建立通信通道或数据路径。” - 由维基百科提供。
- 我们将学习如何发送和接收 UDP 消息，以及如何通过打开和关闭板载 LED 来处理消息内容。一旦掌握了这个练习，您就可以自己实现其他更复杂的控制系统。
  
  为了让事情变得更有趣并展示 MicroBlocks 的最大特性之一 -**便携性**，本教程将使用五个不同的微控制器。您可以尝试任何可用的东西。
  
  项目中使用的微控制器有几个共同的特点：
	- 他们都支持WIFI
	- 它们都有一个板载 LED
	- 其中一些有一个按钮，我们将在我们的项目中使用
- 在下图中，我们展示了所有五个微控制器，并标记了 LED 和按钮的位置。
- ![](https://wiki.microblocks.fun/wifiudp/udptestdevs_marked.jpg)
- https://wiki.microblocks.fun/wifiudp/udpdemoh264.mp4
- 除了控制各种微控制器的程序外，我们还将为您提供一个Android 手机的演示程序，您可以将其用作远程控制设备来参与此练习并发送和接收消息。
-
- >**注意：**此处提到的所有设备（Android 手机除外）都使用相同的精确 MicroBlocks 程序来控制 LED。
- 这是 MicroBlocks 提供的一次编写到处运行 （WRITE-ONCE use on MANY） 功能的一个很好的例子。
- # 组成部分
  
  要完成本教程，您需要：
- 一个或多个具有 WIFI 功能和物理按钮的微控制器。根据您可用的内容，上图中显示的任何一个都可以。
- Android 手机（可选）
  
  如果你只有一个带WIFI功能的单片机，​​那么可以结合安卓手机APP使用。更糟糕的是，如果您没有可用的微控制器，但拥有一部 Android 手机，那么您仍然可以使用您的手机试验本教程。
- > 请确保您**至少有一个带有按钮的微控制器**（M5Stack、ESP8266、ESP32）。该按钮用于生成要发送的消息，没有它您将无法发送消息。
  
  或者，**您也可以使用 Android 手机和没有按钮的微控制器**。
- # 建立连接
  
  由于本练习利用了所用设备的 WIFI 功能，因此不需要物理布线。
  
  就 WIFI 可用性而言，您可以从使用家庭路由器提供的 WIFI 开始。
  
  稍后，我们还将介绍一种方法，您可以使用相同的设备创建自己的 WIFI 热点并提供自己的 WIFI 信号。如果您计划在没有 WIFI 服务的区域操作，这将很方便。
- # 脚本
  
  如上所述，此练习对所有使用的微控制器使用单个项目代码。它们都将运行完全相同的程序并做完全相同的事情：在收到 UDP 消息时打开和关闭板载 LED，并在按下按钮时发送消息。
  
  在下面的脚本图片中，
  ![](https://wiki.microblocks.fun/wifiudp/udpdemo.png)
- **当启动**块处理 WIFI 登录并显示从本地路由器获得的 IP 地址。然后脚本进入接收消息并显示在IDE上的循环。
- **当按钮 A**块发送负载为“LED”的 UDP 广播消息时。
- **当 BUFFER = LED**块作用于接收到的**LED**消息并切换板载 LED。
- ![udpsend_specific.png](https://wiki.microblocks.fun/wifiudp/udpsend_specific.png)
- 我们提供了一个单独的 UDP 发送块，您可以使用它来选择向您自己或其他特定设备发送 UDP 消息。
- 为此，您需要**记**下程序开始时显示的 IP 地址，然后将您的消息定向到测试用例中各个微控制器的特定地址。
- 如果您使用的是**Android APP**，它的 IP 会**显示在屏幕顶部**。
# 过程

我们已经提到了我们项目预期的简单行为：
- **登录**本地WIFI网络并获取IP地址
- 然后**等待**收到“LED”UDP 消息并**切换 LED**。
- **如果按下板载按钮**，则向所有参与者设备发送**广播“LED”消息**。这应该使他们切换各自的 LED。
  
  **请记住用您的特定信息替换程序中的 SSID 和密码。**
  
  简要回顾一下用户数据报协议 (UDP) 操作可能有助于更好地了解我们教程中的所有操作。您可以参考[Wikipedia 中的 UDP 文章](https://en.wikipedia.org/wiki/User_Datagram_Protocol)或其他有关该主题的更详细处理。
-
- ## UDP基础知识
- （由维基百科提供）
  在计算机网络中，用户数据报协议 (UDP) 是 Internet 协议套件的核心通信协议之一，用于向 Internet 协议 (IP) 网络上的其他主机发送消息（以数据包形式传输）。在 IP 网络中，UDP 不需要预先通信来建立通信通道或数据路径。
  
  UDP 使用具有最少协议机制的简单无连接通信模型。UDP 提供端口号，用于寻址数据报源和目标处的不同功能。它没有握手对话，因此无法保证交付、订购或重复保护。
  
  UDP 适用于不需要或在应用程序中执行错误检查和纠正的目的。时间敏感的应用程序通常使用 UDP，因为丢弃数据包比等待由于重传而延迟的数据包更可取，这在实时系统中可能不是一个选项。
  
  **UDP 端口**
  应用程序可以使用数据报套接字建立主机到主机的通信。应用程序将套接字绑定到它的数据传输端点，它是 IP 地址和端口的组合。通过这种方式，UDP 提供了应用程序多路复用。端口是由端口号标识的软件结构，端口号是一个 16 位整数值，允许 0 到 65535 之间的端口号。端口 0 是保留的，但如果发送进程不期望消息在回复。
- ## 我们项目中的UDP
  
  UDP 协议的 MicroBlocks 实现体现在 UDP 库中。在使用该协议之前没有特殊要求，除了所涉及的设备必须存在于共享 IP 网络上，在我们的例子中是我们的本地 WIFI。
- 让我们回顾一下使用的库块：
  ![](https://wiki.microblocks.fun/wifiudp/udpstart.png)
  此块设置脚本以**侦听指定端口上的 UDP 消息。**设备自身的IP地址和指定的端口号组成一个套接字，唯一标识该设备及其提供的任何软件服务。如上所述：
- 如果发送了寻址到端口 5000 的 UDP 广播消息，
- 或发送一个寻址到设备 IP 和端口 5000 的 UDP 消息
  ...我们的脚本将看到并接收它。
  ![](https://wiki.microblocks.fun/wifiudp/udpsend.png)
  此块用于将**UDP 消息发送到指定的 IP 地址和端口。**如上所述，**IP地址255.255.255.255**是一个特殊的**广播地址**，它将用于访问本地子网上的所有IP设备。这使得发送消息变得更加容易，而无需为每个设备的特定 IP 地址而烦恼。
- 请注意，**在 MicroBlocks 中，发送方设备看不到广播消息**。但是，**在 MIT AI2 APP 中，发送电话可以看到广播。**
  也可以使用目标设备的特定 IP 地址和 UDP 端口号发送消息，甚至可以发送到自己的 IP 地址。
  ![](https://wiki.microblocks.fun/wifiudp/udpreceive.png)
  **每当收到 UDP 消息时，此块将包含其内容。**通过检查其长度是否大于零，我们可以查询 UDP 事务的结果。
- 该块还提供了一个**二进制数据**布尔选项，允许接收任何类型的数据。
  库中还有一些其他块没有被我们的项目使用。这些几乎是不言自明的。
  ![](https://wiki.microblocks.fun/wifiudp/udpremoteip.png)- UDP 消息发送者 IP
  ![](https://wiki.microblocks.fun/wifiudp/udpremoteport.png)- UDP发送端口
  ![](https://wiki.microblocks.fun/wifiudp/udpstop.png)- 停止处理 UDP
# AppInventor应用程序

我们为UDPDemo程序提供了安卓配套APP。如果您只有一个微控制器或没有微控制器，它将为您提供额外的灵活性。可以在单片机和手机APP之间发送消息；或者只是将消息从手机发送给自己。此外，它还允许您练习 UDPDemo 项目的一些更高级的功能。

下面两张图片显示了程序开始时的 APP GUI 和接收到 UDP 广播消息时，模拟的 LED 亮起。
- ![](https://wiki.microblocks.fun/wifiudp/udpdemo_app_off_400x.png)
  ![](https://wiki.microblocks.fun/wifiudp/udpdemo_app_on_400x.png)
## 应用程序用户界面

APP GUI由四部分组成：
- **顶部按钮/图像组合：**用于**生成 UDP 广播消息**以切换接收设备的 LED，并显示接收消息的**LED 动作。**
- **UDP Sender Area：**提供对UDP报文**的目的IP地址、目的端口号和本地端口号以及消息文本内容的**详细控制。该区域主要用于测试各种 UDP 消息选项，并在 IP 和端口编号组合方面与其他设备进行实验。
- **UDP 接收区：**提供修改设备正在侦听的**UDP 端口的**能力。
- **消息显示区：****程序的**所有交互和任何错误消息都显示在这个区域。
-
## 如何使用APP

虽然 APP GUI 提供了很多细节，但实际使用起来非常简单。让我们将其分解为各种任务并尝试一下：
- ### 接收 UDP 消息
  
  没有什么可以做的。该程序将在执行后立即开始接收消息。IP 地址是自动获取的，任何发往端口 5000 的 UDP 消息都将被接收和显示。
  
  端口号可以通过UDP 接收器区域中的**本地端口条目字段进行更改。**更改后，APP 将开始处理发往新端口的消息。
- > 要接收消息，必须将其发送到广播地址 255.255.255.255 或电话的特定 IP 地址。在任何一种情况下，端口号都必须与所选的本地端口相匹配。
- ### 发送 UDP 广播来控制 LED
- 同样，没有什么特别要做的，只需**点击屏幕顶部的 LED 图像即可**。将发送到目标 IP = 255.255.255.255 和目标端口 = 5000 的 UDP 广播消息。本地子网上侦听 UDP 端口 5000 的任何设备都应收到这些消息并相应地切换其 LED。这包括您的 Android 手机。每次点击 LED 图像时，**您都会看到自己的 LED 切换。**
- > 此选项设置为始终发送到广播地址和端口 = 5000。这是测试 APP 交换的安全方法。如果您想修改任何 IP 或端口选项，请参阅下面的[发送自定义 UDP 消息](https://wiki.microblocks.fun/wifi/udp#send-customized-udp-messages)。
### 更改本地 UDP 端口

APP 默认监听 UDP 端口 5000。但是，可以通过在APP 的 UDP 接收区的**本地端口字段中输入不同的端口号来更改此设置。**点击**APPLY Change**后，新端口将立即运行。
### 发送定制的 UDP 消息

这是您可以获得对 UDP 消息和参数的完全控制的区域。
您可以指定目标 IP 地址和端口，更改您自己的要发送消息的端口号，并自定义消息文本的内容。

在使用此选项之前，您应该很好地掌握上述所有字段。你可以对任何事情造成伤害。但是，通过以意想不到的方式设置参数，您可能最终会做一些您不希望做的事情，并四处寻找未在正确的目的地和端口接收到的消息。

**如果您想尝试故障安全练习，请尝试向自己发送消息：**
- **将To IP**设置为您自己的 IP 地址
- **将To Port**设置为 5000 或与在 Local Port 中选择的相同端口号
- **将From Port**保留为 5000（此值在本练习中无关紧要）
- **将消息**设置为 LED
  
  然后点击**发送 UDP 消息**按钮。
  
  您应该会在屏幕底部的**消息区域中看到一条消息已发送通知。****屏幕顶部的 LED 图像应根据之前的情况打开或**
  关闭。您可以重复发送消息并相应地观察 LED 切换。
  
  还可以尝试发送具有不同消息文本内容的消息。在这种情况下，由于消息文本不是“LED”，您的 LED 不会切换。但是，您会在屏幕底部的消息区收到消息通知。
  
  现在，如果您喜欢冒险，可以尝试向您的微控制器设备发送消息。
  
  同样的原则适用！我们会让您试验并玩得开心。
# 没有 WIFI，没问题 - 让我们启动 HotSpot！

我们之前提到过，在某些情况下，您想要对设备进行控制的环境可能没有可用的 WIFI 信号。特别是，如果你在树林里或在大自然中或在远离文明的地方。不用担心！您仍然可以按照此处提供的说明来试验本教程。
- ## 我自己的WIFI信号
  
  让我们看看如何激活我们自己的WIFI信号。
  您至少需要一个支持 WIFI 的微控制器。如果您也有 Android 手机，那么您就有生意可做了。
  
  要创建我们自己的 WIFI 信号，我们将使用**MicroBlocks 程序 (UDPDemoHS.ubp) 的修改版本**。此外，在之前版本的练习中，我们为所有设备使用一个程序；这次我们特别需要两个版本：
- **该程序的 WIFI 热点版本**- 这将在单个设备上运行并像您的路由器一样工作：为地址分配提供 WIFI 信号和 DHCP 服务。
- **和之前使用的原始版本**
- 当然，如果您使用的是 Android 手机，您仍然需要相应的 APP。
- ## 它是如何工作的
  为了更好地可视化项目设置，让我们看一下下图。
- ![](https://wiki.microblocks.fun/wifiudp/hotspotnetwork_esp32cell.jpg)
- 我们使用 ESP32-Wroom 微控制器作为 WIFI 热点提供程序。它正在运行 UDPDemoHS.ubp MicroBlocks 程序。这必须是运行该版本程序的唯一设备。在 MicroBlocks 程序中，您将指定一个**网络名称**和一个**密码**，用于**定义和控制对 WIFI 热点的访问**。
- ![](https://wiki.microblocks.fun/wifiudp/wifihsblock.png)
- 提供的块示例将**网络名称显示为 UDPTEST**，将**密码显示为 01223456789。**请随意将这些更改为您想要的任何内容。
- UPDemoHS.ubp 程序与原始版本的不同之处仅在于它创建了一个 WIFI 热点。由于应该只有一个 WIFI 网络可操作，因此只允许一台设备运行该程序。这是创建热点的程序的**启动时间部分：**
- ![](https://wiki.microblocks.fun/wifiudp/wifihswhenstarted.png)
- 所有其他微控制器（如果有的话）都应该运行 UDPDemo.ubp 程序。对于这些设备，您需要将MicroBlocks程序中的SSID和Password修改为属于您创建的WIFI HotSpot的那个。
- 在图中的 ESP32 上，我们标记了板载 LED 和将用于发送 UDP 消息的按钮。每当设备收到 UDP 消息时，其 LED 将切换。
- 为简单起见，我们只添加了运行 MIT AI2 APP 的 Android 智能手机。和以前一样，它会在每次收到 UDP 消息时切换显示屏顶部的 LED 图像。您也可以自己点击图像并使其切换 LED。
- 请记住，UDP 实现的 Android 版本允许从手机发送的广播被手机接收并采取行动。因此，您可以通过同一部手机控制
  手机上的 LED。这对于 ESP32 设备是不可能的。
- 如果您有其他微控制器设备，您可以将它们添加到环境中。它们都应该运行早期版本的 UDPDemo.ubp Microblocks 程序。他们都将像以前一样，在收到每个 UDP 消息时切换各自的 LED。
## 让我们激活新网络

当 ESP32 开始运行时，它会创建一个名为 UDPTEST 的 WIFI 网络。您可以在您的 PC WIFI 网络扫描以及您的 Android 手机 WIFI 扫描上看到这一点。这是您应该寻找的：

![](https://wiki.microblocks.fun/wifiudp/pcwifiscan.png)  ![](https://wiki.microblocks.fun/wifiudp/androidwifiscan.jpg)

对于您将在自己的测试中使用的每个微控制器（充当 WIFI 热点的微控制器除外），您需要修改 MicroBlocks 程序 WIFI 登录以使用新的 WIFI 网络凭据：UDPTEST / 0123456789。

如果你使用的是安卓手机，那么它的WIFI也需要登录新的网络：UDPTEST/0123456789。

完成这些步骤后，一切都应该可以正常运行。

您可以尝试的事情：
- 按下 ESP32 上的按钮，您应该会看到手机 APP 中的 LED 亮起。再次，它应该熄灭。
- 同样，如果您在手机APP中点击LED图片，ESP32 LED会亮起。您的手机 LED 将切换到与之前相反的状态。
- 不断重复，直到你掌握了窍门。
- 如果您喜欢冒险，请尝试使用设备各自的 IP 地址和端口号向设备发送消息。
- > 如果您已经创建了一个 WIFI 热点并用它测试了所有内容，请记住将**其关闭并将您的设备和手机登录到您的正常 WIFI 网络**。否则，您将不会像练习前那样操作，并且想知道为什么没有任何东西像往常一样工作。
- # 讨论
- 不保证 UDP 消息的传递。由于网络状况，您可能会观察到并非所有设备都会在每次按下按钮时切换 LED 的情况。这将使您的一些电路板的 LED 亮起，而其他电路板的 LED 熄灭。你怎么能让所有的板都进入所有 LED 关闭的起始状态？
  
  该项目在每次按下按钮时发送消息。这要求您至少有一个带按钮的微控制器。您如何修改项目以消除此要求？
  
  您认为您可以发送的最长消息是多少？
  
  当前项目切换微控制器的内置 LED。您将如何修改项目以打开/关闭连接到微控制器的外部 LED？
  
  如果您设法完成上述挑战，您还可以使用 RBG LED，而不是普通的单色 LED。您将如何修改项目以控制 RGB LED 显示所需的任何颜色？
  
  Android APP是用MIT的AppInventor编写的。它的行为与项目中使用的微控制器非常相似。如果你熟悉MIT AI2，你能修改APP来从手机控制RGB LED吗？
  
  最后三个挑战非常复杂，需要相当多的专业知识。如果设法让他们工作，你就做得非常好。
- # 指针/故障排除
- 如果您将使用多个支持 WIFI 的微控制器，您会发现一次将程序加载到它们上会更容易。
  
  但是，如果您对此感到满意，您可以在浏览器中运行 MicroBlocks 的多个会话并将微控制器连接到每个会话。
  
  为此，您需要一种方法将多个 USB 设备连接到您的 PC。如果您想尝试在特定设备之间发送单独的消息，此方法稍后也会派上用场。为此，您需要知道他们获得的 IP 地址。MicroBlocks程序运行时，会一直显示获取到的IP地址。
  
  如果您同时管理多个设备，请记住通过名称和驱动程序信息记录哪个设备连接到哪个 USB 端口。事情很快就会变得混乱。
  
  在本教程的第一种模式中，您在您的家庭网络中，您通常会看到 192.168.1.nnn 范围内的家庭网络地址。如果出于某种原因您修改了家庭互联网路由器以分配不同范围的 IP 地址，那么您的地址可能看起来不同。
  
  如果您正在试用本教程的 HotSpot 版本，您将需要了解创建和使用的 IP 地址的差异。
  
  在教程的 HotSpot 模式中，指定的微控制器将创建一个网络并分配一组不同的地址。对于路由器，这些通常看起来像 192.168.4.1，对于其他设备，包括您的 Android 手机（如果您在本教程中使用一个手机），则看起来像 192.168.4.2 及以后。
  
  在教程的 HotSpot 模式下，记得先激活新网络，在我们的例子中是 ESP32。这将设置准备好为加入设备分配地址的环境。您应该只在激活后将手机的 WIFI 连接到新网络。否则，您的手机 WIFI 扫描将看不到 SSID = UDPTEST 的网络。
  
  请记住，在本教程的两个版本中，您永远不会访问 Internet。事实上，在热点版本中，甚至没有任何可用的互联网连接，您会在 WIFI 网络的状态显示中注意到这一点。所有流量交换都发生在您的家庭网络和您使用 HotSpot 选项创建的新网络的私有域内。
  
  两种操作模式下都有上网的方法。但是，就本教程而言，这是一个非常复杂的主题。任何有兴趣的人都可以研究 NAT（网络地址转换）、代理服务、私人和公共互联网地址，并尝试弄清这一切。
  
  清除 PC 和手机中不需要的网络条目的一个好方法是选择忘记该网络选项。您将在设备的 WIFI 连接配置部分找到此选项。
-
## 什么可能出错

由于 UDP 是一种无连接的连接模型，并且无法保证数据报的传递，因此想到的一件事就是“丢失的消息”。UDP 消息不会排队或重试！他们只是被丢弃了。

如果每次按下微控制器（或电话）按钮时，并非所有设备最终都会切换其 LED，请不要感到惊讶；或者间歇性地这样做。就是这样！

这有点令人困惑，但 MicroBlocks WIFI 和 Androd WIFI 处理广播消息的方式不同。这本身不是问题！但在我们进行练习时，将这一点牢记在心是有帮助的。从微控制器发送的广播不会出现在发起广播的设备中。另一方面，Android 手机会广播消息，也会看到消息并据此采取行动。因此，如果您在本教程中使用手机，您会看到每次点击手机上的 LED 图像时，它都会切换其状态。而微控制器永远不会用自己的消息点亮自己的 LED。

编写项目程序以切换 LED。这意味着没有强制方法可以将 LED 设置为所需状态：ON 或 OFF。在程序开始时，所有 LED 均熄灭。但是随着练习的继续，它们可能会由于丢失消息等而变得不同步，如上所述。因此，任何 LED 的后续行为完全取决于它在最后一条消息到达之前所处的状态。

当您试验 UDP 消息传递、广播、IP 和端口设置时，您将不可避免地更改其中一些参数。记住 UDP 消息需要具有匹配的目标地址和端口号会有所帮助。一旦您将设备设置为侦听特定端口号，它就不会看到发往其他端口号的消息。因此，如果您开始没有收到预期的消息，请检查以确保您的发送和接收设备使用的是正确的地址和端口。

请记住，重启一切的最佳方式是重置一切。

享受！
-
# 工程下载

[本教程的 UDPDemo MicroBlocks 程序](https://wiki.microblocks.fun/wifiudp/udpdemo.ubp)- 安装在您想要测试的每个支持 WIFI 的微控制器上。

[用于创建您自己的 WIFI 网络的 UDPDemoHS MicroBlocks 程序](https://wiki.microblocks.fun/wifiudp/udpdemohs.ubp)- 仅安装在您想要充当新网络路由器的单个支持 WIFI 的微控制器上。

[MIT AI2 Android APP Source](https://wiki.microblocks.fun/wifiudp/udpdemo.aia) - 使用 MIT AI2 自定义 APP。
- ![](https://wiki.microblocks.fun/wifiudp/qrcode.jpeg)
- [MIT AI2 Android APP APK](https://wiki.microblocks.fun/wifiudp/udpdemo.apk) - 将此文件旁加载到您的手机。
  可能需要安装未知应用程序的权限。